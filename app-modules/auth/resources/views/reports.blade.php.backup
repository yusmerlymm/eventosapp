@extends('auth::layout')

@section('title', 'Reportes de ventas')

@push('styles')
<style>
    @media print {
        body * {
            visibility: hidden;
        }
        #printable-area, #printable-area * {
            visibility: visible;
        }
        #printable-area {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
        }
    }
</style>
@endpush

@section('content')
<div class="min-vh-100 bg-light py-4">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h1 class="h4 fw-semibold mb-1">Reportes de ventas por evento</h1>
                <p class="text-muted small mb-0">Filtra por periodo para ver el resumen de ventas.</p>
            </div>
            <a href="/admin/dashboard" class="btn btn-outline-primary btn-sm">Volver al dashboard</a>
        </div>

        <div class="card border-0 shadow-sm mb-3">
            <div class="card-body">
                <h2 class="h6 fw-semibold mb-3">Periodo</h2>
                <div class="btn-group" role="group" aria-label="Rango de fechas">
                    <button type="button" class="btn btn-outline-primary btn-sm" data-range="daily">Hoy</button>
                    <button type="button" class="btn btn-outline-primary btn-sm" data-range="weekly">Últimos 7 días</button>
                    <button type="button" class="btn btn-outline-primary btn-sm" data-range="monthly">Últimos 30 días</button>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-3">
            <div class="col-12 col-md-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <p class="text-muted small mb-1">Entradas vendidas</p>
                        <p class="h4 mb-0" id="rep-total-tickets">-</p>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <p class="text-muted small mb-1">Importe total</p>
                        <p class="h4 mb-0" id="rep-total-amount">-</p>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <p class="text-muted small mb-1">Eventos con ventas</p>
                        <p class="h4 mb-0" id="rep-events-count">-</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h2 class="h6 fw-semibold mb-0">Ventas por evento</h2>
                        <small class="text-muted" id="rep-period-label"></small>
                    </div>
                    <button type="button" id="btn-export-pdf" class="btn btn-outline-primary btn-sm">Descargar PDF</button>
                    <button type="button" id="btn-print" class="btn btn-outline-secondary btn-sm ms-2">
                        <i class="bi bi-printer"></i> Imprimir
                    </button>
                </div>
                <div id="printable-area">
                    <h4 class="mb-3">Reporte de ventas por evento</h4>
                    <p class="text-muted small mb-3" id="report-period-text"></p>
                    <div class="table-responsive">
                    <table class="table table-sm align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Evento</th>
                                <th class="text-end">Entradas</th>
                                <th class="text-end">Importe total</th>
                            </tr>
                        </thead>
                        <tbody id="rep-table-body">
                            <tr>
                                <td colspan="3" class="text-center text-muted small py-3">Selecciona un periodo para ver los datos.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<script>
// Configuración global para jsPDF
const { jsPDF } = window.jspdf;

const rangeButtons = document.querySelectorAll('[data-range]');
let currentRange = 'daily';
let lastReportData = null;

// Función para formatear fechas
function formatDate(date) {
    return new Date(date).toLocaleDateString('es-ES', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Función para generar PDF
async function generatePDF() {
    try {
        const element = document.getElementById('printable-area');
        const originalDisplay = element.style.display;
        
        // Mostrar el área imprimible temporalmente
        element.style.display = 'block';
        
        // Usar html2canvas para capturar el contenido
        const canvas = await html2canvas(element, {
            scale: 2, // Mayor resolución
            useCORS: true,
            allowTaint: true,
            scrollY: -window.scrollY
        });
        
        // Crear PDF
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF('p', 'mm', 'a4');
        const imgWidth = 190; // Ancho máximo en mm (A4 con márgenes)
        const pageHeight = 277; // Altura de página A4 en mm
        const imgHeight = canvas.height * imgWidth / canvas.width;
        let heightLeft = imgHeight;
        let position = 10; // Margen superior en mm
        
        // Agregar la primera página
        pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
        heightLeft -= pageHeight - 20; // Restar margen inferior
        
        // Agregar páginas adicionales si es necesario
        while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 10, -position, imgWidth, imgHeight);
            heightLeft -= pageHeight - 20;
        }
        
        // Restaurar la visualización original
        element.style.display = originalDisplay;
        
        // Descargar el PDF
        pdf.save(`reporte_ventas_${currentRange}.pdf`);
        
    } catch (error) {
        console.error('Error al generar el PDF:', error);
        alert('Error al generar el PDF. Por favor, inténtalo de nuevo.');
    }
}

// Función para manejar la impresión
function handlePrint() {
    const printContents = document.getElementById('printable-area').innerHTML;
    const originalContents = document.body.innerHTML;
    
    document.body.innerHTML = printContents;
    window.print();
    document.body.innerHTML = originalContents;
    window.location.reload();
}

async function loadReport(range) {
    currentRange = range;
    rangeButtons.forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-range') === range);
    });

    const token = localStorage.getItem('auth_token');
    if (!token) {
        alert('Debes iniciar sesión como administrador.');
        return;
    }

    const params = new URLSearchParams({ range });

    const res = await fetch('/api/admin/reports/sales?' + params.toString(), {
        headers: {
            'Authorization': 'Bearer ' + token,
            'Accept': 'application/json'
        }
    });

    const data = await res.json();

    // Guardar última data para exportar
    lastReportData = data;
    const totalTickets = Number(data.summary.total_tickets ?? 0) || 0;
    const totalAmount = Number(data.summary.total_amount ?? 0) || 0;
    const eventsCount = Number(data.summary.events_count ?? 0) || 0;

    document.getElementById('rep-total-tickets').textContent = totalTickets;
    document.getElementById('rep-total-amount').textContent = totalAmount.toFixed(2);
    document.getElementById('rep-events-count').textContent = eventsCount;
    document.getElementById('rep-period-label').textContent = data.summary.label || '';

    const tbody = document.getElementById('rep-table-body');
    tbody.innerHTML = '';

    if (!data.events || data.events.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="3" class="text-center text-muted small py-3">No hay ventas en este periodo.</td>';
        tbody.appendChild(tr);
        return;
    }

    data.events.forEach(ev => {
        const totalTicketsEv = Number(ev.total_tickets ?? 0) || 0;
        const totalAmountEv = Number(ev.total_amount ?? 0) || 0;
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${ev.event_name}</td>
            <td class="text-end">${totalTicketsEv}</td>
            <td class="text-end">${totalAmountEv.toFixed(2)}</td>
        `;
        tbody.appendChild(tr);
    });
}

rangeButtons.forEach(btn => {
    btn.addEventListener('click', () => loadReport(btn.getAttribute('data-range')));
});

// La función de exportación se ha movido a initExportButton()

// Función para inicializar el botón de exportación
function initExportButton() {
    const exportBtn = document.getElementById('btn-export-pdf');
    if (!exportBtn) return;

    exportBtn.addEventListener('click', async () => {
        const btn = document.getElementById('btn-export-pdf');
        const originalText = btn.innerHTML;
        
        try {
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generando...';
            
            if (!lastReportData || !lastReportData.events || lastReportData.events.length === 0) {
                alert('No hay datos para exportar.');
                return;
                ws[cellRef].s = { font: { bold: true, sz: 14 }, alignment: { horizontal: 'center' } };
            }
            
            // Formato de moneda para la columna de importe
            for (let R = 4; R <= range.e.r; ++R) {
                const cellAddress = { c: 2, r: R };
                const cellRef = XLSX.utils.encode_cell(cellAddress);
                if (ws[cellRef]) {
                    ws[cellRef].t = 'n';
                    ws[cellRef].z = '#,##0.00';
                }
            }

            // Ajustar el ancho de las columnas
            ws['!cols'] = [
                { wch: 40 }, // Evento
                { wch: 15 }, // Entradas
                { wch: 20 }  // Importe total
            ];

            // Agregar la hoja al libro
            XLSX.utils.book_append_sheet(wb, ws, 'Reporte de Ventas');

            // Configurar propiedades básicas del documento
            if (!wb.Props) wb.Props = {};
            wb.Props.Title = 'Reporte de Ventas';
            wb.Props.Author = 'Sistema de Eventos';
            wb.Props.CreatedDate = new Date();
            
            // Marcar como documento final (solo lectura)
            wb.Props.ContentStatus = 'Final';
            
            // Configuración de Workbook
            if (!wb.Workbook) wb.Workbook = {};
            
            // Agregar una hoja de propiedades personalizadas para marcar como solo lectura
            if (!wb.Workbook.CustomProperties) wb.Workbook.CustomProperties = [];
            wb.Workbook.CustomProperties.push('_MarkAsFinal');
            
            // Configurar protección de la hoja de cálculo (sin contraseña)
            if (!ws['!protection']) {
                ws['!protection'] = {};
            }
            
            // Generar el archivo Excel con opciones mejoradas
            const excelBuffer = XLSX.write(wb, { 
                bookType: 'xlsx', 
                type: 'array',
                bookSST: true,
                cellStyles: true,
                ignoreEC: true  // Ignorar errores de compatibilidad
            });
            
            // Crear un Blob con el tipo MIME correcto
            const blob = new Blob([excelBuffer], { 
                type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=UTF-8'
            });
            
            // Establecer atributo de solo lectura en el Blob
            Object.defineProperty(blob, 'isReadOnly', { value: true });
            
            // Crear enlace de descarga
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `reporte_ventas_${currentRange}.xlsx`;
            document.body.appendChild(a);
            a.click();
            
            // Limpiar
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 200);
            
        } catch (error) {
            console.error('Error al generar el archivo Excel:', error);
            alert('Error al generar el archivo. Por favor, inténtalo de nuevo.');
        }
    });
}

// Cargar la biblioteca SheetJS (xlsx) para exportar a Excel
function loadXLSX() {
    return new Promise((resolve, reject) => {
        if (typeof XLSX !== 'undefined') {
            resolve();
            return;
        }

        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
        
        script.onload = () => resolve();
        script.onerror = () => reject(new Error('Error al cargar la biblioteca XLSX'));
        
        document.head.appendChild(script);
    });
}

// Inicializar la aplicación
async function initApp() {
    try {
        // Cargar la biblioteca XLSX
        await loadXLSX();
        
        // Inicializar el botón de exportación
        initExportButton();
        
        // Cargar por defecto "Hoy"
        loadReport('daily');
        
    } catch (error) {
        console.error('Error al inicializar la aplicación:', error);
        alert('Error al cargar las dependencias necesarias. Por favor, recarga la página.');
    }
}

// Iniciar la aplicación cuando el DOM esté listo
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initApp);
} else {
    initApp();
}
</script>
@endsection
